---
# TODO:
# - https://github.com/marketplace/actions/magic-nix-cache
# - https://github.com/marketplace/actions/nix-flake-checker
# - https://github.com/marketplace/actions/the-determinate-nix-installer
# - https://github.com/marketplace/actions/deadnix-action

name: 'Run prod flake checks and build'

on:
  push:
    branches:
      - 'prod*'

jobs:
  nix-check:
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout code ğŸ•¸ï¸ğŸ›’ğŸ'
        uses: 'actions/checkout@v3'
        with:
          fetch-depth: 0

      - name: 'Install nix ğŸ•¸ï¸â„ï¸ğŸ”§'
        uses: DeterminateSystems/nix-installer-action@main

      - name: 'Use magic nix cache ğŸ•¸ï¸âœ¨ğŸ”®'
        uses: DeterminateSystems/magic-nix-cache-action@main
        # uses: cachix/install-nix-action@v22

      - name: 'Pre-commit checks ğŸ•¸ï¸ğŸ”âœ…'
        run: |
          nix-shell --run 'pre-commit run --all-files'

      - name: 'Run checks ğŸ•¸ï¸â„ï¸âœ”ï¸'
        run: 'nix flake check'

  nix-build:
    strategy:
      matrix:
        os:
          - 'ubuntu-latest'
          - 'macos-latest'
    runs-on: '${{ matrix.os }}'
    steps:
      - name: 'Checkout ğŸš…ğŸ›’ğŸğŸš€ï¸'
        uses: 'actions/checkout@v3'
        with:
          fetch-depth: 0

      - name: 'Install nix ğŸš…â„ï¸ğŸ”§ğŸš€ï¸'
        uses: cachix/install-nix-action@v22

      - name: 'Build ğŸš…ğŸ› ï¸ğŸ“¦ğŸš€ï¸'
        id: 'build'
        run: |
          export SYSTEM=$(nix eval --impure --raw --expr "builtins.currentSystem")
          echo "system=$SYSTEM" >> $GITHUB_ENV
          nix build ".#buildJobs.${SYSTEM}.combined" -vL
          echo "result=$(readlink result)" >> $GITHUB_ENV

      - name: 'Upload result ğŸš…ğŸ“¤ğŸâœ…ğŸš€ï¸'
        uses: actions/upload-artifact@v3
        with:
          name: 'result-${{ steps.build.outputs.system }}'
          path: '${{ steps.build.outputs.result }}'
