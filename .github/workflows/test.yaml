name: "Test"
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - 'staging*'
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: 'Install nix ğŸ§™ğŸ½â„ï¸ğŸ”§'
        env:
          NIXPKGS_COMMIT_TAG: 23.05
          NIXPKGS_URL: https://github.com/NixOS/nixpkgs/archive/refs/tags/${{ env.NIXPKGS_COMMIT_TAG }}.tar.gz
        uses: DeterminateSystems/nix-installer-action@main
        with:
          nix-package-url: ${{ env.NIXPKGS_URL }}
        retry: 3

      - name: 'Use magic nix cache ğŸ§™ğŸ½âœ¨ğŸ”®'
        env:
          CACHIX_URL: https://ryzengrind.cachix.org
        uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          upstream-cache: ${{ env.CACHIX_URL }}
      - run: nix-build
      - run: nix-shell --run "echo OK"
      - name: Run checks
        run: nix flake check || echo "Nix flake check failed!"
        continue-on-error: true