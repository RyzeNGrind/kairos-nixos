---
## TODO
## Consider:
## - https://github.com/marketplace/actions/magic-nix-cache
## - https://github.com/marketplace/actions/nix-flake-checker
## - https://github.com/marketplace/actions/the-determinate-nix-installer
## - https://github.com/marketplace/actions/deadnix-action

name: 'Run dev flake checks'

on:
  push:
    branches:
      - 'dev*'

jobs:
  nix-check:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code ğŸ±â€ğŸ‘¤ğŸ›’ğŸ“¦'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'Install nix ğŸ±â€ğŸ‘¤â„ï¸ğŸ”§'
        uses: DeterminateSystems/nix-installer-action@main

      - name: 'Use magic nix cache ğŸ±â€ğŸ‘¤âœ¨ğŸ”®'
        uses: DeterminateSystems/magic-nix-cache-action@main
        # uses: cachix/install-nix-action@v22

      - name: Pre-commit checks ğŸ±â€ğŸ‘¤ğŸ”âœ…
        run: |
          nix-shell --run 'pre-commit run --all-files'

      - name: 'Run checks ğŸ±â€ğŸ‘¤â„ï¸âœ”ï¸'
        run: nix flake check

  nix-build:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          #- macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: 'Checkout ğŸ§™ğŸ½ğŸ›’ğŸ“¦'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'Install nix ğŸ§™ğŸ½â„ï¸ğŸ”§'
        uses: cachix/install-nix-action@v22

      - name: 'Build ğŸ§™ğŸ½ğŸ› ï¸ğŸ“¦'
        id: build
        run: |
          export SYSTEM=$(nix eval --impure --raw --expr "builtins.currentSystem")
          echo "system=$SYSTEM" >> $GITHUB_ENV
          nix build ".#buildJobs.${SYSTEM}.combined" -vL
          echo "result=$(readlink result)" >> $GITHUB_ENV

      - name: 'Upload result ğŸ§™ğŸ½ğŸ“¤ğŸ“¦ğŸ”„'
        uses: actions/upload-artifact@v2
        with:
          name: result-${{ steps.build.outputs.system }}
          path: ${{ steps.build.outputs.result }}
